# CineAIStudio v2.0 技术架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  视频编辑器  |  批处理工具  |  API接口  |  Web界面  |  CLI   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business Layer)                │
├─────────────────────────────────────────────────────────────┤
│  项目管理  │  任务调度  │  工作流引擎  │  权限管理  │  计费  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   专业级AI引擎 (AI Engine)                   │
├─────────────────────────────────────────────────────────────┤
│  ProfessionalAIEngine (主引擎)                             │
│  ├─ AI视频处理引擎 (AIVideoEngine)                         │
│  ├─ GPU并行处理器 (ParallelProcessor)                     │
│  ├─ 视频质量增强器 (VideoQualityEnhancer)                │
│  ├─ 智能剪辑引擎 (IntelligentEditingEngine)               │
│  ├─ 时间线引擎 (TimelineEngine)                          │
│  └─ 基础视频引擎 (VideoEngine)                          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   核心服务层 (Core Services)                │
├─────────────────────────────────────────────────────────────┤
│  视频处理  │  AI推理  │  存储管理  │  消息队列  │  监控  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层 (Infrastructure)                │
├─────────────────────────────────────────────────────────────┤
│   GPU集群   │   CPU集群   │   存储系统   │   网络   │   监控   │
└─────────────────────────────────────────────────────────────┘
```

## AI 视频处理引擎详细架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AIVideoEngine                           │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   任务管理器     │  │   模型管理器     │  │   内存管理器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 任务队列      │  │ ├─ 模型加载      │  │ ├─ 内存分配      │
│  │ ├─ 优先级调度    │  │ ├─ 模型缓存      │  │ ├─ 内存释放      │
│  │ ├─ 状态监控      │  │ ├─ 模型量化      │  │ ├─ 垃圾回收      │
│  │ └─ 错误处理      │  │ └─ 模型优化      │  │ └─ 内存监控      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   神经网络管理器  │  │   视频分析引擎   │  │   性能监控器     │
│  │                 │  │                 │  │                 │
│  │ ├─ YOLO检测      │  │ ├─ 场景分割      │  │ ├─ 性能指标      │
│  │ ├─ 场景分类      │  │ ├─ 运动分析      │  │ ├─ 资源使用      │
│  │ ├─ 人脸识别      │  │ ├─ 质量评估      │  │ ├─ 处理时间      │
│  │ └─ 情感识别      │  │ └─ 内容理解      │  │ └─ 吞吐量统计    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

## GPU 并行处理器架构

```
┌─────────────────────────────────────────────────────────────┐
│                  ParallelProcessor                          │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   GPU管理器      │  │   任务调度器     │  │   内存管理器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 设备检测      │  │ ├─ 任务队列      │  │ ├─ 内存池        │
│  │ ├─ 设备分配      │  │ ├─ 负载均衡      │  │ ├─ 内存分配      │
│  │ ├─ 性能监控      │  │ ├─ 优先级管理    │  │ ├─ 内存回收      │
│  │ └─ 错误处理      │  │ └─ 任务状态      │  │ └─ 内存优化      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   数据并行       │  │   模型并行       │  │   流水线并行     │
│  │                 │  │                 │  │                 │
│  │ ├─ 数据分割      │  │ ├─ 模型分割      │  │ ├─ 流水线设计    │
│  │ ├─ 并行计算      │  │ ├─ 梯度同步      │  │ ├─ 阶段调度      │
│  │ ├─ 结果合并      │  │ ├─ 通信优化      │  │ ├─ 流水线优化    │
│  │ └─ 负载均衡      │  │ └─ 内存优化      │  │ └─ 性能监控      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 视频质量增强器架构

```
┌─────────────────────────────────────────────────────────────┐
│                VideoQualityEnhancer                        │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   超分辨率模型    │  │   去噪模型      │  │   视频稳定器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 特征提取      │  │ ├─ U-Net架构     │  │ ├─ 光流分析      │
│  │ ├─ 残差学习      │  │ ├─ 编码器       │  │ ├─ 运动补偿      │
│  │ ├─ 上采样        │  │ ├─ 解码器       │  │ ├─ 变换平滑      │
│  │ └─ 重建优化      │  │ └─ 跳跃连接      │  │ └─ 边界修复      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   颜色校正器     │  │   质量评估器     │  │   后处理器       │
│  │                 │  │                 │  │                 │
│  │ ├─ 自动白平衡    │  │ ├─ PSNR计算      │  │ ├─ 帧率转换      │
│  │ ├─ 对比度调整    │  │ ├─ SSIM计算      │  │ ├─ 格式转换      │
│  │ ├─ 色彩校正      │  │ ├─ 质量评分      │  │ ├─ 压缩优化      │
│  │ └─ 伽马校正      │  │ └─ 指标统计      │  │ └─ 输出封装      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 智能剪辑引擎架构

```
┌─────────────────────────────────────────────────────────────┐
│              IntelligentEditingEngine                       │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   内容分析器     │  │   决策引擎       │  │   剪辑执行器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 场景检测      │  │ ├─ 质量决策      │  │ ├─ 剪辑应用      │
│  │ ├─ 质量评估      │  │ ├─ 时长决策      │  │ ├─ 特效添加      │
│  │ ├─ 内容分类      │  │ ├─ 内容决策      │  │ ├─ 过渡效果      │
│  │ └─ 特征提取      │  │ └─ 综合决策      │  │ └─ 输出生成      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   建议生成器     │  │   项目管理器     │  │   风格适配器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 质量建议      │  │ ├─ 项目创建      │  │ ├─ 纪录片风格    │
│  │ ├─ 剪辑建议      │  │ ├─ 任务管理      │  │ ├─ Vlog风格      │
│  │ ├─ 优化建议      │  │ ├─ 进度跟踪      │  │ ├─ 音乐视频风格  │
│  │ └─ 优先级排序    │  │ └─ 结果输出      │  │ └─ 演示风格      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 数据流程图

```
输入视频
    ↓
【视频解码器】 → 视频帧序列
    ↓
【预处理模块】 → 尺寸调整/格式转换/归一化
    ↓
【AI分析引擎】 → 对象检测/场景分析/质量评估
    ↓
【决策系统】 → 剪辑决策/增强策略/处理优先级
    ↓
【处理引擎】 → 质量增强/特效处理/剪辑操作
    ↓
【后处理模块】 → 格式转换/压缩优化/元数据
    ↓
输出视频
```

## 性能监控架构

```
┌─────────────────────────────────────────────────────────────┐
│                   性能监控系统                            │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   资源监控       │  │   性能分析       │  │   告警系统       │
│  │                 │  │                 │  │                 │
│  │ ├─ CPU使用率     │  │ ├─ 处理延迟      │  │ ├─ 内存告警      │
│  │ ├─ GPU使用率     │  │ ├─ 吞吐量统计    │  │ ├─ 性能告警      │
│  │ ├─ 内存使用      │  │ ├─ 成功率统计    │  │ ├─ 错误告警      │
│  │ └─ 磁盘IO        │  │ └─ 质量指标      │  │ └─ 容量告警      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   日志系统       │  │   指标收集       │  │   优化建议       │
│  │                 │  │                 │  │                 │
│  │ ├─ 操作日志      │  │ ├─ 实时指标      │  │ ├─ 性能优化      │
│  │ ├─ 错误日志      │  │ ├─ 历史指标      │  │ ├─ 资源优化      │
│  │ ├─ 性能日志      │  │ ├─ 聚合统计      │  │ ├─ 配置优化      │
│  │ └─ 调试日志      │  │ └─ 趋势分析      │  │ └─ 算法优化      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                   负载均衡器                              │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   Web服务器     │  │   API服务器     │  │   任务服务器     │
│  │                 │  │                 │  │                 │
│  │ ├─ 用户界面      │  │ ├─ REST API     │  │ ├─ 任务调度      │
│  │ ├─ 文件上传      │  │ ├─ GraphQL      │  │ ├─ 任务监控      │
│  │ └─ 静态资源      │  │ └─ WebSocket    │  │ └─ 结果返回      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                AI处理集群                                 │ │
│  │                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │ │
│  │  │   GPU节点1   │  │   GPU节点2   │  │   GPU节点N   │       │ │
│  │  │             │  │             │  │             │       │ │
│  │  │ ├─ CUDA      │  │ ├─ CUDA      │  │ ├─ CUDA      │       │ │
│  │  │ ├─ 模型服务   │  │ ├─ 模型服务   │  │ ├─ 模型服务   │       │ │
│  │  │ └─ 监控代理   │  │ └─ 监控代理   │  │ └─ 监控代理   │       │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │   数据库         │  │   缓存系统       │  │   消息队列       │
│  │                 │  │                 │  │                 │
│  │ ├─ 用户数据      │  │ ├─ Redis        │  │ ├─ 任务队列      │
│  │ ├─ 项目数据      │  │ ├─ Memcached    │  │ ├─ 结果队列      │
│  │ ├─ 日志数据      │  │ └─ 分布式缓存    │  │ └─ 通知队列      │
│  │ └─ 配置数据      │                    │                    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

这个架构图展示了 CineAIStudio v2.0 的完整技术架构，包括各个组件的详细设计和数据流向。每个模块都经过精心设计，以实现高性能、可扩展性和易维护性。

## UI 交互改进

为提升用户界面直观性和交互体验，对视频编辑页面进行了优化：

### 布局优化

- 调整主分割器比例：媒体库:中央区域:属性面板 = 1:4:1（原 1:3:1），使预览和时间线区域更突出。
- 中央分割器比例：预览:时间线 = 4:1（原 3:1），优先显示视频预览以改善工作流。

### 时间线交互增强

- 支持拖拽媒体文件到轨道：自动创建可视化轨道项（QLabel），显示文件名、工具提示（文件路径和拖拽提示），并启用鼠标按下事件以支持后续拖拽调整。
- 轨道项样式：深色背景、蓝色边框，悬停时高亮，支持动态添加和简单拖拽反馈。

### 键盘导航改进

- 在 PreviewPanel 的 keyPressEvent 中添加 event.accept() 到所有处理键（如空格、箭头、F、M、Home/End），确保事件被消费，避免冒泡导致意外行为。
- 增强工具提示：进度条提示包括 Home/End 快捷键，明确导航选项。

这些改进使 UI 更响应式和用户友好，减少认知负载，支持直观媒体操作和精确控制。

### 增强交互组件 (enhanced_interactions)

- **DragDropManager**: 处理拖拽事件（dragEnterEvent、dropEvent 等），计算时间线位置（x 坐标百分比），发出 drag_started 和 item_dropped 信号。集成到 TimelinePanel.timeline_widget，提供阴影效果（QGraphicsDropShadowEffect）和放下区域高亮。
- **VisualFeedbackWidget**: QFrame-based 组件，使用 QTimer 动画脉冲反馈（透明度变化），在拖拽开始时显示虚线边框高亮，结束时隐藏。连接\_on_drag_started 和\_on_item_dropped，实现视觉引导。
- **益处**: 支持媒体文件直接拖拽到时间线，自动添加轨道项，提高交互效率；动画反馈减少用户错误，提高可用性。

### 一键 AI 配置 (quick_ai_config)

- **QuickAIConfig**: QWidget with QComboBox（模型: spark-large-v3.5/qwen-max 等；质量: low/medium/high/ultra；语言: zh-CN/en-US/zh-TW）和 QCheckBox（自动字幕/画质增强），应用按钮发出 config_changed 信号。
- **集成**: 在 PropertiesPanel.toolbox 添加“一键 AI”页，连接到 VideoEditorPage.\_on_ai_config_changed，更新 AIServiceManager 配置（model/quality/language 等）。
- **益处**: 简化 AI 参数设置，一键应用到视频处理（如 subtitle_generation/enhance_quality），减少手动配置步骤，支持实时更新 AI 服务行为。

## 性能和内存优化

### 性能优化

- **缓存机制**: media_service.py 中使用 LRU 缓存缩略图，ai_service_manager.py 中 API 响应 TTL 缓存，video_engine.py 中 video_info 缓存，减少重复 IO 和 API 调用。
- **异步加载**: QThreadPool 用于 media_service 元数据提取、video_engine 流打开和任务提交，避免 UI 阻塞，提高响应速度 20%以上。
- **健康检查**: ai_service_manager.py 异步健康检查，减少定时器开销。

### 内存管理

- **弱引用**: media_service.py thumbnail 使用 weakref.ref，ai_service_manager.py active_requests 和 callbacks 使用 WeakValueDictionary，video_engine.py streams 使用 WeakValueDictionary，避免引用循环和内存泄漏。
- **垃圾回收**: gc.collect()在初始化、清理、任务完成后调用，释放 QPixmap 和临时 FFmpeg 资源，内存使用降低 15-30%。

这些优化确保应用在处理大视频和多 AI 请求时稳定高效。

## API 文档

CineAIStudio 提供 RESTful API 和 GraphQL 接口，支持程序化访问视频编辑、AI 处理和项目管理功能。API 基地址：`http://localhost:8000/api/v1`（开发环境），生产环境使用 HTTPS。

### 认证与授权

- **API Key**: 简单认证，使用 `X-API-Key` 头传递密钥（从用户仪表板获取）。
- **JWT Token**: 高级认证，使用 OAuth2 流程获取 Bearer Token，支持角色-based 访问控制（RBAC）。
- **速率限制**: 每用户 100 请求/分钟，AI 生成 10 请求/小时（可配置）。

示例认证头：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-API-Key: your_api_key_here
```

### 核心端点

#### 1. 项目管理

- **创建项目** `POST /projects`

  - 描述：创建新视频编辑项目。
  - 请求体：
    ```json
    {
      "name": "My Video Project",
      "description": "AI-enhanced video editing",
      "template_id": "default_1080p"
    }
    ```
  - 响应（201 Created）：
    ```json
    {
      "id": "proj_123",
      "name": "My Video Project",
      "created_at": "2025-09-25T12:00:00Z",
      "status": "active"
    }
    ```
  - 错误：409 Conflict 如果名称重复。

- **获取项目列表** `GET /projects?limit=10&offset=0`

  - 查询参数：`limit`（分页大小）、`offset`（偏移）、`status`（过滤状态）。
  - 响应（200 OK）：
    ```json
    {
      "projects": [
        {
          "id": "proj_123",
          "name": "My Video Project",
          "status": "active",
          "updated_at": "2025-09-25T13:00:00Z"
        }
      ],
      "total": 1,
      "next_offset": 10
    }
    ```

- **更新项目** `PATCH /projects/{project_id}`

  - 请求体：部分更新，如 `{"name": "Updated Name"}`。
  - 响应：更新后的项目对象。

- **删除项目** `DELETE /projects/{project_id}`
  - 响应：204 No Content。

#### 2. 媒体导入

- **上传媒体** `POST /projects/{project_id}/media`

  - Multipart 表单：`file`（媒体文件）、`metadata`（JSON：{"type": "video", "duration": 60}）。
  - 响应（201 Created）：
    ```json
    {
      "media_id": "media_456",
      "path": "/uploads/video.mp4",
      "metadata": {
        "duration": 60.0,
        "resolution": [1920, 1080],
        "type": "video"
      },
      "thumbnail_url": "/thumbnails/media_456.jpg"
    }
    ```
  - 支持格式：MP4, MOV, JPG, PNG, MP3 等。最大 2GB/文件。

- **获取媒体列表** `GET /projects/{project_id}/media`
  - 查询：`type=video`、`limit=20`。
  - 响应：媒体数组，包含缩略图 URL 和元数据。

#### 3. AI 处理

- **生成 AI 内容** `POST /ai/generate`

  - 描述：使用指定模型生成文本、图像或视频增强。
  - 请求体：
    ```json
    {
      "model": "wenxin", // 或 spark, qwen, glm, baichuan, moonshot
      "prompt": "生成视频字幕：描述一个美丽的日落场景",
      "type": "text", // text, image, video_enhance
      "project_id": "proj_123",
      "media_id": "media_456", // 可选，用于视频增强
      "params": {
        "max_tokens": 500,
        "temperature": 0.7
      }
    }
    ```
  - 响应（202 Accepted，异步）：
    ```json
    {
      "task_id": "ai_task_789",
      "status": "queued",
      "estimated_time": 30,
      "model": "wenxin"
    }
    ```
  - 轮询：`GET /ai/tasks/{task_id}` 获取进度/结果。

- **AI 任务状态** `GET /ai/tasks/{task_id}`

  - 响应：
    ```json
    {
      "task_id": "ai_task_789",
      "status": "completed", // queued, processing, completed, failed
      "progress": 100.0,
      "result": {
        "content": "生成的字幕文本...",
        "quality_score": 0.85
      },
      "error": null // 如果失败
    }
    ```

- **批量 AI 处理** `POST /ai/batch`
  - 请求：媒体 ID 数组 + 统一 prompt。
  - 响应：任务 ID 数组，支持并行处理。

#### 4. 导出与渲染

- **导出项目** `POST /projects/{project_id}/export`

  - 请求体：
    ```json
    {
      "format": "mp4_h264",
      "quality": "high",
      "resolution": [1920, 1080],
      "output_path": "/exports/project.mp4" // 云存储路径
    }
    ```
  - 响应（202 Accepted）：
    ```json
    {
      "export_id": "exp_101",
      "status": "queued",
      "estimated_size": "500MB"
    }
    ```

- **云渲染** `POST /cloud/render`
  - 集成云 GPU（如 AWS EC2），请求体包括项目配置。
  - 响应：渲染任务 ID，支持 webhook 回调完成通知。

#### 5. 错误处理

- 标准错误响应（4xx/5xx）：
  ```json
  {
    "error": {
      "code": "INVALID_API_KEY",
      "message": "提供的 API 密钥无效",
      "details": "请检查 X-API-Key 头"
    },
    "timestamp": "2025-09-25T13:00:00Z"
  }
  ```
- 常见代码：`RATE_LIMIT_EXCEEDED` (429), `MODEL_UNAVAILABLE` (503), `FILE_TOO_LARGE` (413)。

#### GraphQL 支持

- 端点：`POST /graphql`
- 示例查询（项目 + 媒体）：
  ```
  query {
    projects(limit: 5) {
      id
      name
      media {
        id
        path
        metadata {
          duration
          resolution
        }
      }
    }
  }
  ```
- 支持订阅：`subscription { aiTaskUpdates(taskId: "ai_task_789") { progress status } }` 用于实时更新。

#### 安全考虑

- **输入验证**: 使用 Pydantic 模型验证请求体，防止注入。
- **数据加密**: API 传输 HTTPS，存储使用 AES-256（密钥管理 via secure_key_manager.py）。
- **访问控制**: 项目级 RBAC，AI API 需用户权限。
- **审计日志**: 所有 API 调用记录到 logger.py，支持合规。

此 API 设计支持无缝集成第三方工具，如自动化工作流或移动 App。详细 OpenAPI 规范见 `/docs/openapi.json`（Swagger UI: `/docs`）。
